/*!  - v2.2.2
 * https://premium.wpmudev.org/project/coursepress-pro/
 * Copyright (c) 2019; * Licensed GPLv2+ */
_.extend(_coursepress_upgrade,{totalCourses:0,totalSuccess:0,totalSend:0,events:Backbone.Events,upgrade:Backbone.Model.extend({url:_coursepress_upgrade.ajax_url+"?action=coursepress_upgrade_from_1x",initialize:function(a){_.extend(this,a),this.on("error",this.server_error,this);var b={_wpnonce:_coursepress_upgrade._wpnonce,course_id:this.course_id,user_id:this.user_id,container:!1,total_courses:_coursepress_upgrade.totalCourses,total_success:_coursepress_upgrade.totalSuccess};this.set(b),this.save()},parse:function(a){var b=this.container.$el.find(".course-progress");a&&(a.success?b.hasClass("error")||(b.addClass("success"),_coursepress_upgrade.totalSuccess+=1):b.hasClass("success")||(b.addClass("error"),_coursepress_upgrade.totalError+=1)),_coursepress_upgrade.totalSend+=1,_coursepress_upgrade.events.trigger("coursepress_update_done",this)},server_error:function(){window.alert(_coursepress_upgrade.server_error)}}),checkStudents:Backbone.Model.extend({url:_coursepress_upgrade.ajax_url+"?action=coursepress_upgrade_from_1x",initialize:function(a){_.extend(this,a),this.on("error",this.server_error,this),this.set({_wpnonce:_coursepress_upgrade._wpnonce,type:"check-students",course_id:-1})},parse:function(a){if(0===a)return void _coursepress_upgrade.events.trigger("all_students_upgraded",this);a.success?a.data.remaining_students<=0?_coursepress_upgrade.events.trigger("all_students_upgraded",this):_coursepress_upgrade.events.trigger("students_upgraded",a.data.remaining_students,this):_coursepress_upgrade.events.trigger("students_upgrade_failed",this)},server_error:function(){window.alert(_coursepress_upgrade.server_error)}}),studentsView:Backbone.View.extend({className:"coursepress-update-view",template:'<span class="students-upgrade-message"></span> <span class="students-progress"></span> <span class="course-progress"></span>',initialize:function(a){_.extend(this,a),this.remaining_students="",_coursepress_upgrade.events.on("students_upgraded",_.bind(this.students_upgraded,this)),_coursepress_upgrade.events.on("all_students_upgraded",_.bind(this.all_students_upgraded,this)),_coursepress_upgrade.events.on("students_upgrade_failed",_.bind(this.students_upgrade_failed,this))},students_upgraded:function(a){this.remaining_students=a,this.render()},all_students_upgraded:function(){this.$el.find(".students-progress").html("0"),this.$el.find(".course-progress").removeClass("error").addClass("success")},students_upgrade_failed:function(){this.$el.find(".course-progress").removeClass("success").addClass("error")},render:function(){this.$el.html(this.template),this.$el.find(".students-upgrade-message").html(_coursepress_upgrade.upgrading_students),this.$el.find(".students-progress").html(this.remaining_students),this.$el.insertBefore(this.submit_button),new _coursepress_upgrade.checkStudents({}).save()}}),view:Backbone.View.extend({className:"coursepress-update-view",input:!1,template:'<span class="course-title"></span> <span class="course-progress"></span>',initialize:function(a){_.extend(this,a),this.render()},render:function(){if(this.input){var a,b;b=this.input.val(),this.input.parents().find("#cp-updated-"+b).remove(),a=this.input.data("name"),this.$el.append(this.template),this.$el.attr("id","cp-updated-"+b),this.$el.find(".course-title").html(a),this.$el.insertAfter(this.input),""!==this.input.data("done")?(_coursepress_upgrade.totalSuccess+=1,_coursepress_upgrade.totalSend+=1,this.$el.find(".course-progress").addClass("success"),_coursepress_upgrade.events.trigger("coursepress_update_done",this)):this.sync=new _coursepress_upgrade.upgrade({course_id:this.input.val(),type:this.input.data("type"),container:this,user_id:this.user_id})}}})}),function(a){var b=function(){function b(){var b=o.get(p);i=new _coursepress_upgrade.view({input:a(b),user_id:r}),p++}function c(){q.parent().removeClass("notice-warning").addClass("notice-error"),q.html(_coursepress_upgrade.failed)}function d(){q.parent().removeClass("notice-warning"),q.html(_coursepress_upgrade.success),h=5,g=setInterval(function(){h-=1,q.find(".coursepress-counter").html(h),0===h&&(clearInterval(g),window.location=_coursepress_upgrade.cp2_url)},1e3)}var e,f,g,h,i,j,k,l,m,n=a(this),o=a('[name="course"]',n),p=0,q=a(".coursepress-upgrade-nag p"),r=a('[name="user_id"]',n).val(),s=n.find('[type="submit"]');return!s.is(":disabled")&&(0===q.length&&(f=a(".coursepress-upgrade-view h2"),q=a('<div class="notice notice-warning is-dismissible coursepress-upgrade-nag">').insertAfter(f),q=a("<p>").appendTo(q)),s.attr("disabled","disabled"),q.parent().removeClass("notice-error").addClass("notice-warning"),q.html(_coursepress_upgrade.noloading),_coursepress_upgrade.totalCourses=o.length,_coursepress_upgrade.totalSend=0,_coursepress_upgrade.totalSuccess=0,b(),e=function(){_coursepress_upgrade.totalCourses===_coursepress_upgrade.totalSend?_coursepress_upgrade.totalCourses===_coursepress_upgrade.totalSuccess?(l=new _coursepress_upgrade.studentsView({submit_button:s.closest("p")}),l.render()):c():b()},j=function(){clearInterval(m),d()},k=function(){clearInterval(m),c()},_coursepress_upgrade.events.off("coursepress_update_done"),_coursepress_upgrade.events.on("coursepress_update_done",e),_coursepress_upgrade.events.on("all_students_upgraded",j),_coursepress_upgrade.events.on("students_upgrade_failed",k),!1)};a(document).on("submit","#coursepress-update-form",b)}(jQuery);